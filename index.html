<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://www.youtube.com/iframe_api"></script>
    <title>YouTube Video + Map Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; }
        .main-row { display: flex; gap: 2em; justify-content: center; align-items: flex-start; }
        .main-col { flex: 1; min-width: 350px; max-width: 600px; box-sizing: border-box; padding: 0.5em; }
        #ytPlayer, #map { width: 100%; height: 400px; border-radius: 12px; box-shadow: 0 2px 12px #0001; background: #fff; overflow: hidden; }
        #progressContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2em;
        }
        .globe {
            width: 60px;
            height: 60px;
            background: url('https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg') no-repeat center/cover;
            border-radius: 50%;
            margin-bottom: 1em;
            animation: spin 2s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ytPlayer, #map, #locationsBar { display: none; }
        #locationsBar {
            margin: 2em auto 0 auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5em;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 6px #0001;
            padding: 0.5em 1em;
            min-height: 48px;
            max-width: 90vw;
        }
        .location-pill {
            padding: 0.4em 1em;
            border-radius: 20px;
            background: #e9ecef;
            color: #333;
            font-size: 1.05em;
            transition: background 0.2s, color 0.2s;
            white-space: nowrap;
        }
        .location-pill.active {
            background: #0074D9;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 8px #0074d933;
        }
        .input-group { max-width: 600px; margin: 0 auto; }
        @media (max-width: 900px) {
            .main-row { flex-direction: column; gap: 1em; }
            .main-col { max-width: 100%; }
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="mb-3">YouTube Video + Map Sync</h2>
    <form id="ytForm" class="mb-4">
        <div class="input-group">
            <input type="text" class="form-control" id="youtubeUrl" placeholder="Paste YouTube link here" required>
            <button class="btn btn-primary" type="submit">Load</button>
        </div>
    </form>
    <div id="status" class="mb-3"></div>
    <div id="progressContainer">
        <div class="globe"></div>
        <div class="progress w-75">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
        </div>
        <div id="progressText" class="mt-2"></div>
    </div>
    <div class="main-row">
        <div class="main-col">
            <div id="ytPlayer"></div>
        </div>
        <div class="main-col">
            <div id="map"></div>
        </div>
    </div>
    <div id="locationsBar"></div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
<script>
let map, marker, path = [];
let ytPlayer, ytInterval;
let firstMarkerAdded = false;

// Replace with your Mapbox access token
mapboxgl.accessToken = 'pk.eyJ1IjoidnIwMG4tbnljc2J1cyIsImEiOiJjbDViczI0NmMwMW42M2JwYmdubmUwOGJ3In0.YroblDcHdFwFXo38QL0vxQ';

function initMap() {
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [ -73.9855, 40.758 ], // [lon, lat]
        zoom: 3
    });
}

function updateMap(ts) {
    if (!path.length) return;
    // Find the last point at or before the current timestamp
    let idx = -1;
    for (let i = 0; i < path.length; i++) {
        if (path[i].timestamp <= ts) idx = i;
        else break;
    }
    if (idx === -1) {
        // Before the first location, hide marker and path
        if (marker) marker.remove();
        if (map.getSource && map.getSource('route')) {
            map.getSource('route').setData({
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: [] }
            });
        }
        updateLocationsBar([]);
        return;
    }
    // Show path up to the current point
    const pts = path.slice(0, idx + 1);
    // Add marker if not already added
    if (!firstMarkerAdded) {
        marker = new mapboxgl.Marker().setLngLat([pts[pts.length-1].lon, pts[pts.length-1].lat]).addTo(map);
        firstMarkerAdded = true;
    } else {
        marker.setLngLat([pts[pts.length-1].lon, pts[pts.length-1].lat]);
    }
    map.flyTo({
        center: [pts[pts.length-1].lon, pts[pts.length-1].lat],
        zoom: 5,
        essential: true,
        duration: 2000
    });
    updatePathLine(idx);
    updateLocationsBar(pts, idx);
}

function updatePathLine(idx) {
    const coords = path.slice(0, idx + 1).map(p => [p.lon, p.lat]);
    if (map.getSource('route')) {
        map.getSource('route').setData({
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: coords }
        });
    } else {
        map.addSource('route', {
            type: 'geojson',
            data: {
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: coords }
            }
        });
        map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#0074D9', 'line-width': 4 }
        });
    }
}

function updateLocationsBar(pts, idx) {
    const bar = document.getElementById('locationsBar');
    if (!pts.length) {
        bar.innerHTML = '';
        bar.style.display = 'none';
        return;
    }
    bar.innerHTML = path.map((p, i) =>
        `<span class="location-pill${i === (idx ?? -1) ? ' active' : ''}">${p.place}</span>`
    ).join('');
    bar.style.display = 'flex';
}

function onYouTubeIframeAPIReady() {
    // This function is called automatically by the API
    if (window.currentVideoId) {
        ytPlayer = new YT.Player('ytPlayer', {
            height: '400',
            width: '100%',
            videoId: window.currentVideoId,
            events: {
                'onReady': onPlayerReady
            }
        });
    }
}

function onPlayerReady(event) {
    ytInterval = setInterval(() => {
        const ts = ytPlayer.getCurrentTime();
        updateMap(ts);
    }, 500);
}

document.getElementById('ytForm').onsubmit = async (e) => {
    e.preventDefault();
    document.getElementById('status').textContent = '';
    document.getElementById('ytPlayer').style.display = 'none';
    document.getElementById('map').style.display = 'none';
    document.getElementById('locationsBar').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'flex';
    firstMarkerAdded = false;
    // Fake progress bar animation
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressText.textContent = 'Processing video...';
    let fakeInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 5;
            progressBar.style.width = Math.floor(progress) + '%';
            progressBar.textContent = Math.floor(progress) + '%';
        }
    }, 200);

    const url = document.getElementById('youtubeUrl').value;
    const resp = await fetch('/process', {
        method: 'POST',
        body: new URLSearchParams({youtube_url: url}),
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    });
    clearInterval(fakeInterval);
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    progressText.textContent = 'Done!';
    setTimeout(() => {
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('ytPlayer').style.display = 'block';
        document.getElementById('map').style.display = 'block';
        document.getElementById('locationsBar').style.display = 'flex';
        // Ensure map resizes correctly when shown
        if (window.map && typeof window.map.resize === 'function') {
            setTimeout(() => window.map.resize(), 100);
        }
    }, 800);

    const data = await resp.json();
    if (data.error) {
        document.getElementById('status').textContent = data.error;
        return;
    }
    path = data.path;
    console.log("Loaded path:", path);
    if (!path.length) {
        document.getElementById('status').textContent = 'No locations found in transcript.';
        return;
    }
    // Initialize map and marker
    if (map) map.remove();
    initMap();
    // Do NOT show marker until first location is reached in updateMap(ts)
    // Load YouTube video using IFrame API
    window.currentVideoId = data.video_id;
    document.getElementById('ytPlayer').innerHTML = ""; // Clear previous
    if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
        // If API not loaded yet, it will call onYouTubeIframeAPIReady automatically
        return;
    }
    onYouTubeIframeAPIReady();
};
</script>
</body>
</html>
