<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Playback - Audio + Map Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', Arial, sans-serif; }
        .main-container { max-width: 700px; margin: 2em auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #0001; padding: 2em 1.5em; }
        #map { width: 100%; height: 350px; border-radius: 12px; box-shadow: 0 2px 12px #0001; background: #fff; overflow: hidden; margin-bottom: 1.5em; }
        .locations-bar { margin: 1em 0; display: flex; flex-wrap: wrap; gap: 0.5em; justify-content: center; }
        .location-pill { padding: 0.4em 1em; border-radius: 20px; background: #e9ecef; color: #333; font-size: 1.05em; transition: background 0.2s, color 0.2s; white-space: nowrap; }
        .location-pill.active { background: #0074D9; color: #fff; font-weight: bold; box-shadow: 0 2px 8px #0074d933; }
    </style>
</head>
<body>
<div class="main-container">
    <a href="record.html" class="btn btn-link mb-3">&larr; Back to Recorder</a>
    <h3 class="mb-3">Playback</h3>
    <audio id="audio" controls style="width:100%; margin-bottom:1em;"></audio>
    <div id="map"></div>
    <div class="locations-bar" id="locationsBar"></div>
</div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoidnIwMG4tbnljc2J1cyIsImEiOiJjbDViczI0NmMwMW42M2JwYmdubmUwOGJ3In0.YroblDcHdFwFXo38QL0vxQ'; // <-- Replace with your actual Mapbox token
const rec_id = "{{ rec_id }}";
const audio = document.getElementById('audio');
let path = [], map, marker;

function fetchData() {
    // Fetch audio
    audio.src = `/audio/${rec_id}`;
    // Fetch locations
    fetch(`/locations/${rec_id}`)
        .then(r => r.json())
        .then(data => {
            try {
                if (typeof data === 'string') {
                    path = JSON.parse(data);
                } else if (Array.isArray(data)) {
                    path = data;
                } else {
                    path = [];
                }
            } catch {
                path = [];
            }
            if (path.length) {
                initMap();
                updateLocationsBar(0);
            } else {
                document.getElementById('map').innerHTML = '<div class="alert alert-warning">No location data found for this recording.</div>';
            }
        });
}

function initMap() {
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [path[0][0], path[0][1]],
        zoom: 9
    });

    marker = new mapboxgl.Marker()
        .setLngLat([path[0][0], path[0][1]])
        .addTo(map);

    map.on('load', () => {
        map.resize();
        updateLocationsBar(0);
    });

    map.on('move', () => {
        updateLocationsBar(map.getCenter().lng);
    });
}

function updateLocationsBar(lng) {
    // Implementation of updateLocationsBar function
}
</script> 
</body>
</html> 
