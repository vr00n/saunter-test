<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Playback - Audio + Map Sync</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-family: 'Segoe UI', Arial, sans-serif; }
        .main-container { max-width: 700px; margin: 2em auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #0001; padding: 2em 1.5em; }
        #map { width: 100%; height: 350px; border-radius: 12px; box-shadow: 0 2px 12px #0001; background: #fff; overflow: hidden; margin-bottom: 1.5em; }
        .locations-bar { margin: 1em 0; display: flex; flex-wrap: wrap; gap: 0.5em; justify-content: center; }
        .location-pill { padding: 0.4em 1em; border-radius: 20px; background: #e9ecef; color: #333; font-size: 1.05em; transition: background 0.2s, color 0.2s; white-space: nowrap; }
        .location-pill.active { background: #0074D9; color: #fff; font-weight: bold; box-shadow: 0 2px 8px #0074d933; }
    </style>
</head>
<body>
<div class="main-container">
    <a href="record.html" class="btn btn-link mb-3">&larr; Back to Recorder</a>
    <h3 class="mb-3">Playback</h3>
    <audio id="audio" controls style="width:100%; margin-bottom:1em;"></audio>
    <div id="map"></div>
    <div class="locations-bar" id="locationsBar"></div>
</div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
<script>
const rec_id = "{{ rec_id }}";
const audio = document.getElementById('audio');
let path = [], map, marker;

function fetchData() {
    // Fetch audio
    audio.src = `/audio/${rec_id}`;
    // Fetch locations
    fetch(`/locations/${rec_id}`)
        .then(r => r.json())
        .then(data => {
            try {
                path = JSON.parse(data);
            } catch {
                path = [];
            }
            if (path.length) {
                initMap();
                updateLocationsBar(0);
            }
        });
}

function initMap() {
    map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [path[0].lon, path[0].lat],
        zoom: 13
    });
    marker = new mapboxgl.Marker().setLngLat([path[0].lon, path[0].lat]).addTo(map);
    map.on('load', () => updatePathLine(0));
}

function updatePathLine(idx) {
    const coords = path.slice(0, idx + 1).map(p => [p.lon, p.lat]);
    if (map.getSource('route')) {
        map.getSource('route').setData({
            type: 'Feature',
            geometry: { type: 'LineString', coordinates: coords }
        });
    } else {
        map.addSource('route', {
            type: 'geojson',
            data: {
                type: 'Feature',
                geometry: { type: 'LineString', coordinates: coords }
            }
        });
        map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#0074D9', 'line-width': 4 }
        });
    }
}

function updateLocationsBar(idx) {
    const bar = document.getElementById('locationsBar');
    bar.innerHTML = path.map((p, i) =>
        `<span class="location-pill${i === idx ? ' active' : ''}">${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}</span>`
    ).join('');
    bar.style.display = 'flex';
}

audio.ontimeupdate = function() {
    if (!path.length) return;
    const ts = audio.currentTime * 1000; // audio.currentTime is in seconds, locations use ms
    // Find the last point at or before the current timestamp
    let idx = 0;
    for (let i = 0; i < path.length; i++) {
        if (path[i].timestamp <= ts) idx = i;
        else break;
    }
    marker.setLngLat([path[idx].lon, path[idx].lat]);
    map.flyTo({center: [path[idx].lon, path[idx].lat], zoom: 15, essential: true, duration: 500});
    updatePathLine(idx);
    updateLocationsBar(idx);
};

window.onload = fetchData;
</script>
</body>
</html> 